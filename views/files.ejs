<!DOCTYPE html>
<html>
  <%include header%>
  <body>
    <%include navbar%>
    <div class="container-fluid">
      <div class="row">
        <%include menus%>
        <div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-2 main">
          <p><button type="button" class="btn btn-default" data-toggle="modal" data-target="#upload">上传</button></p>
          <div id="files-table"></div>
        </div>
        <%include forms/uploadFile%>
      </div>
    </div>
    <%include footer%>
    <script>
      function remove(id) {
        if(confirm('确认要删除此文件?')){
          $.ajax({
            type: 'DELETE',
            url: '/api/file/'+id,
            dataType: 'json',
            success: function (result) {
              alert(result.msg);
              window.location.reload();
            }
          });
        }
      }

      function download(id) {
        window.open('/api/file/download?id='+id);
      }

      function loadFiles(type) {
        $.ajax({
          type:'GET',
          data:{type:type},
          url:'/api/files',
          dataType: 'json',
          success: function(result){
            console.log(result);
            if(result.code==1){
              var html = '';
              if(result.data.length>0){
                html += '<table class="table table-striped table-bordered table-hover table-condensed">';
                html += '<thead><tr><td>文件名</td><td>文件类型</td><td>上传时间</td><td>操作</td></tr></thead>';
                html += '<tbody>';
                result.data.forEach(function (file) {
                  html += '<tr>';
                  html += '<td>'+file.name+'</td>';
                  html += '<td>'+file.type+'</td>';
                  html += '<td>'+file.createTime+'</td>';
                  html += '<td>';
                  html += '<button type="button" class="btn btn-default" onclick="remove('+"'"+file._id+"'" +')">删除</button>';
                  html += '<button type="button" class="btn btn-default" onclick="download('+"'"+file._id+"'" +')">下载</button>';
                  html += '<td>';
                  html += '</tr>';
                });
                html += '</tbody>';
                html += '</table>';
                $('#files-table').html(html);
              }
            }
          }
        });
      }
      $(document).ready(function () {
        loadFiles('all');
        $('#files').addClass('active');
        $('#confirm').click(function () {
          $('#upload-file').ajaxSubmit({
            success: function (result) {
              alert(result.msg);
              window.location.reload();
            }
          });
        });
      });
    </script>
  </body>
</html>
